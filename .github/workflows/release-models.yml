name: Release Zenz CoreML

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest

    steps:
      - name: Validate version input format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "Requested version: $VERSION"

          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid version: '$VERSION'"
            echo "   Use semantic version format: X.Y.Z (e.g. 3.1.0)"
            exit 1
          fi

          echo "✅ Version format OK"

      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Install Git LFS
        run: |
          brew install git-lfs
          git lfs install
          git lfs pull

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Core ML conversion dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install coremltools==9.0 torch==2.7.0 transformers==4.57.1 sentencepiece

      - name: Convert Hugging Face models to Core ML bundles
        run: |
          set -euo pipefail

          python convert-to-CoreML.py
          python convert-to-CoreML-Stateful.py

      - name: Install Tuist
        run: |
          brew install tuist

      - name: Remove Package.swift before Tuist
        run: |
          rm -f Package.swift

      - name: Tuist install dependencies
        run: |
          tuist install

      - name: Generate Xcode project with Tuist
        run: |
          tuist generate --no-open

      - name: Build xcframeworks
        run: |
          chmod +x Scripts/build_xcframeworks.sh
          ./Scripts/build_xcframeworks.sh

      - name: Zip .mlpackage bundles
        run: |
          mkdir -p dist
          for dir in Stateless/*.mlpackage Stateful/*.mlpackage; do
            [ -d "$dir" ] || continue
            name=$(basename "$dir")
            zip -r "dist/${name}.zip" "$dir"
          done

      - name: Debug artifacts
        run: |
          echo "=== dist contents ==="
          ls -R dist || echo "dist is empty"
          echo "=== BuildArtifacts contents ==="
          ls -R BuildArtifacts || echo "BuildArtifacts is empty"

      - name: Generate Package.swift from artifacts
        env:
          VERSION: ${{ github.event.inputs.version }}
          REPO_SLUG: Skyline-23/zenz-CoreML
        run: |
          set -euo pipefail

          TAG="v${VERSION}"

          echo "Version: ${VERSION}, Tag: ${TAG}"

          checksum() {
            local name="$1" # e.g. ZenzCoreMLStateful8bit
            swift package compute-checksum "BuildArtifacts/${name}.xcframework.zip"
          }

          CS_STATELESS=$(checksum "ZenzCoreMLStateless")
          CS_STATELESS_8=$(checksum "ZenzCoreMLStateless8bit")
          CS_STATEFUL=$(checksum "ZenzCoreMLStateful")
          CS_STATEFUL_8=$(checksum "ZenzCoreMLStateful8bit")

          cat > Package.swift <<EOF
            // swift-tools-version: 6.1
            import PackageDescription

            let package = Package(
                name: "ZenzCoreMLPackage",
                platforms: [
                    .iOS(.v18),
                    .macOS(.v15)
                ],
                products: [
                    .library(
                        name: "ZenzCoreMLStateless",
                        targets: ["ZenzCoreMLStateless"]
                    ),
                    .library(
                        name: "ZenzCoreMLStateless8bit",
                        targets: ["ZenzCoreMLStateless8bit"]
                    ),
                    .library(
                        name: "ZenzCoreMLStateful",
                        targets: ["ZenzCoreMLStateful"]
                    ),
                    .library(
                        name: "ZenzCoreMLStateful8bit",
                        targets: ["ZenzCoreMLStateful8bit"]
                    )
                ],
                targets: [
                    .binaryTarget(
                        name: "ZenzCoreMLStateless",
                        url: "https://github.com/${REPO_SLUG}/releases/download/${TAG}/ZenzCoreMLStateless.xcframework.zip",
                        checksum: "${CS_STATELESS}"
                    ),
                    .binaryTarget(
                        name: "ZenzCoreMLStateless8bit",
                        url: "https://github.com/${REPO_SLUG}/releases/download/${TAG}/ZenzCoreMLStateless8bit.xcframework.zip",
                        checksum: "${CS_STATELESS_8}"
                    ),
                    .binaryTarget(
                        name: "ZenzCoreMLStateful",
                        url: "https://github.com/${REPO_SLUG}/releases/download/${TAG}/ZenzCoreMLStateful.xcframework.zip",
                        checksum: "${CS_STATEFUL}"
                    ),
                    .binaryTarget(
                        name: "ZenzCoreMLStateful8bit",
                        url: "https://github.com/${REPO_SLUG}/releases/download/${TAG}/ZenzCoreMLStateful8bit.xcframework.zip",
                        checksum: "${CS_STATEFUL_8}"
                    )
                ]
            )
          EOF

          echo "=== Generated Package.swift ==="
          cat Package.swift

      - name: Commit & tag updated Package.swift
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          TAG="v${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Package.swift
          git commit -m "Release ${TAG} [skip ci]" || echo "No changes to commit"

          git push origin HEAD:main

          git tag "${TAG}"
          git push origin "${TAG}"

      - name: Create GitHub Release & upload assets
        uses: softprops/action-gh-release@v1
        env:
          VERSION: ${{ github.event.inputs.version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: "Zenz CoreML v${{ github.event.inputs.version }}"
          draft: false
          prerelease: false
          files: |
            dist/*
            BuildArtifacts/*.xcframework.zip
